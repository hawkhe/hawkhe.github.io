<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Librbd学习1: 调试环境搭建 | Hawk's Blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="编译Ceph
首先我们搭建一个可以编译Ceph RBD的环境出来"><meta name=generator content="Hugo 0.110.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Librbd学习1: 调试环境搭建"><meta property="og:description" content="编译Ceph
首先我们搭建一个可以编译Ceph RBD的环境出来"><meta property="og:type" content="article"><meta property="og:url" content="https://hawkhe.github.io/post/librbd_compile/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-07-22T04:42:07+00:00"><meta property="article:modified_time" content="2022-07-22T04:42:07+00:00"><meta itemprop=name content="Librbd学习1: 调试环境搭建"><meta itemprop=description content="编译Ceph
首先我们搭建一个可以编译Ceph RBD的环境出来"><meta itemprop=datePublished content="2022-07-22T04:42:07+00:00"><meta itemprop=dateModified content="2022-07-22T04:42:07+00:00"><meta itemprop=wordCount content="1170"><meta itemprop=keywords content="librbd,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Librbd学习1: 调试环境搭建"><meta name=twitter:description content="编译Ceph
首先我们搭建一个可以编译Ceph RBD的环境出来"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Hawk's Blog</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Articles page">Articles</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">ARTICLES</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Librbd学习1: 调试环境搭建</h1><time class="f6 mv4 dib tracked" datetime=2022-07-22T04:42:07Z>July 22, 2022<ul class=pa0>Tags:<li class="list di"><a href=/tags/librbd/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">librbd</a></li></ul></time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-100"><h2 id=编译ceph>编译Ceph</h2><p>首先我们搭建一个可以编译Ceph RBD的环境出来</p><p>编译环境</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:~# cat /etc/lsb-release
</span></span><span style=display:flex><span>DISTRIB_ID<span style=color:#f92672>=</span>Ubuntu
</span></span><span style=display:flex><span>DISTRIB_RELEASE<span style=color:#f92672>=</span>20.04
</span></span><span style=display:flex><span>DISTRIB_CODENAME<span style=color:#f92672>=</span>focal
</span></span><span style=display:flex><span>DISTRIB_DESCRIPTION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Ubuntu 20.04 LTS&#34;</span>
</span></span></code></pre></div><p>下载Ceph源码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:/work# git clone --branch v15.2.16 https://github.com/ceph/ceph.git
</span></span></code></pre></div><p>下载源码依赖</p><pre tabindex=0><code>root@haosheng-dev2:/work# cd ceph
root@haosheng-dev2:/work/ceph# git submodule update --init --recursive
</code></pre><p>安装依赖包</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph# ./install-deps.sh
</code></pre><p>因为后面需要使用gdb调试程序，故需要以debug模式进行编译</p><p>配置debug相关参数，并执行do_cmake.sh</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph# ARGS=&#34;-DCMAKE_C_FLAGS=-O0 -g3 -gdwarf-4 -DCMAKE_CXX_FLAGS=-O0 -g3 -gdwarf-4&#34; ./do_cmake.sh -DWITH_MGR_DASHBOARD_FRONTEND=off
</code></pre><p>cmake添加的参数的解释:</p><ul><li><em>CMAKE_C_FLAGS=“-O0 -g3 -gdwarf-4”</em> ： c 语言编译配置</li><li><em>CMAKE_CXX_FLAGS=“-O0 -g3 -gdwarf-4”</em> ：c++ 编译配置</li><li><em>-O0</em> : 关闭编译器的优化，如果没有，使用GDB追踪程序时，大多数变量被优化,无法显示, 生产环境必须关掉</li><li><em>-g3</em> : 意味着会产生大量的调试信息</li><li><em>-gdwarf-4</em> : dwarf 是一种调试格式，dwarf-4 版本为4</li></ul><p>执行编译</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:/work/ceph# cd build
</span></span><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build# make -j4
</span></span></code></pre></div><p>查看编译后的库文件</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph/build# ll -h lib/librbd.so*
lrwxrwxrwx 1 root root   11 Apr 20 09:56 lib/librbd.so -&gt; librbd.so.1*
lrwxrwxrwx 1 root root   16 Apr 20 09:56 lib/librbd.so.1 -&gt; librbd.so.1.12.0*
-rwxr-xr-x 1 root root 212M Apr 20 09:56 lib/librbd.so.1.12.0*
</code></pre><h2 id=启动集群>启动集群</h2><p>使用vstart启动虚拟集群</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph/build# make vstart
root@haosheng-dev2:/work/ceph/build# MON=1 OSD=3 MGR=1 ../src/vstart.sh --debug --new --localhost --filestore
</code></pre><p>查看虚拟集群状态</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph/build# ./bin/ceph -s
*** DEVELOPER MODE: setting PATH, PYTHONPATH and LD_LIBRARY_PATH ***
2022-04-21T02:20:33.537+0000 7f6684d4e700 -1 WARNING: all dangerous and experimental features are enabled.
2022-04-21T02:20:33.561+0000 7f6684d4e700 -1 WARNING: all dangerous and experimental features are enabled.
  cluster:
    id:     54a63c07-ace5-44cf-9baf-7e0649c435d1
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum a (age 44s)
    mgr: x(active, since 39s)
    mds: a:1 {0=c=up:active} 2 up:standby
    osd: 3 osds: 3 up (since 31s), 3 in (since 31s)

  data:
    pools:   3 pools, 65 pgs
    objects: 22 objects, 2.2 KiB
    usage:   148 GiB used, 451 GiB / 600 GiB avail
    pgs:     65 active+clean

  io:
    client:   0 B/s wr, 0 op/s rd, 0 op/s wr
</code></pre><p>创建一个用于测试的存储池</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph/build# ./bin/ceph osd pool create test 8 8 replicated
*** DEVELOPER MODE: setting PATH, PYTHONPATH and LD_LIBRARY_PATH ***
2022-04-21T02:43:58.265+0000 7ff89b461700 -1 WARNING: all dangerous and experimental features are enabled.
2022-04-21T02:43:58.305+0000 7ff89b461700 -1 WARNING: all dangerous and experimental features are enabled.
pool &#39;test&#39; created
</code></pre><h2 id=编写客户端程序>编写客户端程序</h2><h3 id=使用librados库的程序>使用librados库的程序</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// -*- mode:C++; tab-width:8; c-basic-offset:2; indent-tabs-mode:t -*-
</span></span></span><span style=display:flex><span><span style=color:#75715e>// vim: ts=8 sw=2 smarttab
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Ceph - scalable distributed file system
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * This is free software; you can redistribute it and/or
</span></span></span><span style=display:flex><span><span style=color:#75715e> * modify it under the terms of the GNU Lesser General Public
</span></span></span><span style=display:flex><span><span style=color:#75715e> * License version 2.1, as published by the Free Software
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Foundation. See file COPYING.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// install the librados-dev and librbd package to get this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;rados/librados.hpp&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;rbd/librbd.hpp&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sstream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pool_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string image_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rbd1&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> test_data[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello rbd!</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we will use all of these below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    librados<span style=color:#f92672>::</span>IoCtx io_ctx;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// first, we create a Rados object and initialize it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    librados<span style=color:#f92672>::</span>Rados rados;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> rados.<span style=color:#a6e22e>init</span>(<span style=color:#e6db74>&#34;admin&#34;</span>); <span style=color:#75715e>// just use the client.admin keyring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        { <span style=color:#75715e>// let&#39;s handle any error that might have come back
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;couldn&#39;t initialize rados! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just set up a rados cluster object&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Now we need to get the rados object its config info. It can
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * parse argv for us to find the id, monitors, etc, so let&#39;s just
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * use that.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> rados.<span style=color:#a6e22e>conf_parse_argv</span>(argc, argv);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// This really can&#39;t happen, but we need to check to be a good citizen.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;failed to parse config options! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just parsed our config options&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            <span style=color:#75715e>// We also want to apply the config file if the user specified
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// one, and conf_parse_argv won&#39;t do that for us.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> argc; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ((<span style=color:#a6e22e>strcmp</span>(argv[i], <span style=color:#e6db74>&#34;-c&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    ret <span style=color:#f92672>=</span> rados.<span style=color:#a6e22e>conf_read_file</span>(argv[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// This could fail if the config file is malformed, but it&#39;d be hard.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;failed to parse config file &#34;</span> <span style=color:#f92672>&lt;&lt;</span> argv[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>                                  <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;! error&#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>                        ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * next, we actually connect to the cluster
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> rados.<span style=color:#a6e22e>connect</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;couldn&#39;t connect to cluster! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just connected to the rados cluster&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * create an &#34;IoCtx&#34; which is used to do IO to a pool
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> rados.<span style=color:#a6e22e>ioctx_create</span>(pool_name, io_ctx);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;couldn&#39;t set up ioctx! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just created an ioctx for our pool&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * open an rbd image and write data to it
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        librbd<span style=color:#f92672>::</span>RBD rbd;
</span></span><span style=display:flex><span>        librbd<span style=color:#f92672>::</span>Image image;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> rbd.<span style=color:#a6e22e>open</span>(io_ctx, image, image_name.<span style=color:#a6e22e>c_str</span>(), NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;couldn&#39;t open the rbd image! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just opened the rbd image&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>size_t</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(test_data);
</span></span><span style=display:flex><span>        ceph<span style=color:#f92672>::</span>bufferlist bl;
</span></span><span style=display:flex><span>        bl.<span style=color:#a6e22e>append</span>(test_data, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> image.<span style=color:#a6e22e>write</span>(<span style=color:#ae81ff>0</span>, len, bl);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cerr <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;couldn&#39;t write to the rbd image! error &#34;</span> <span style=color:#f92672>&lt;&lt;</span> ret <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> EXIT_FAILURE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;we just wrote data to our rbd image &#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        image.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> EXIT_SUCCESS;
</span></span><span style=display:flex><span>out:
</span></span><span style=display:flex><span>    rados.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=执行编译>执行编译</h3><pre tabindex=0><code>root@haosheng-dev2:/work/ceph_test# g++ -g hello_rbd.cc -lrados -lrbd -I/work/ceph/src/include -L/work/ceph/build/lib -o hello_rbd -Wl,-rpath,/work/ceph/build/lib
</code></pre><p>gcc各个参数的意义:</p><ul><li><em>-g</em> : 允许gdb调试</li><li><em>-lrados</em> : -l 指定依赖库的名字为rados</li><li>-I : 指定编译时依赖的librados.h头文件的路径</li><li><em>-L</em> : 指定编译时依赖库的的路径， 如果不指定将在系统目录下寻找</li><li><em>-o</em> : 编译的二进制文件名</li><li><em>-Wl</em> : 指定编译时参数</li><li><em>-rpath</em> : 指定运行时依赖库的路径， 如果不指定将在系统目录下寻找</li></ul><h3 id=运行并查看结果>运行并查看结果</h3><p>创建存储池与镜像</p><pre tabindex=0><code>root@haosheng-dev2:/work/ceph/build# ./bin/ceph osd pool create test 8 8 replicated
root@haosheng-dev2:/work/ceph/build#
root@haosheng-dev2:/work/ceph/build# ./bin/rbd create test/rbd1 --size 32MB
root@haosheng-dev2:/work/ceph/build#
root@haosheng-dev2:/work/ceph/build# ./bin/rbd ls -p test
rbd1
</code></pre><p>运行程序</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:/work/ceph_test# ./hello_rbd -c /work/ceph/build/ceph.conf             we just set up a rados cluster object
</span></span><span style=display:flex><span>we just parsed our config options
</span></span><span style=display:flex><span>we just connected to the rados cluster
</span></span><span style=display:flex><span>we just created an ioctx <span style=color:#66d9ef>for</span> our pool
</span></span><span style=display:flex><span>we just opened the rbd image
</span></span><span style=display:flex><span>we just wrote data to our rbd image
</span></span></code></pre></div><p>查看结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build# ./bin/rados ls -p test
</span></span><span style=display:flex><span>test-write
</span></span><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build#
</span></span><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build# ./bin/rbd export test/rbd1 /tmp/test_rbd1
</span></span><span style=display:flex><span>Exporting image: 100% complete...done.
</span></span><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build#
</span></span><span style=display:flex><span>root@haosheng-dev2:/work/ceph/build# hexdump -C /tmp/test_rbd1
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span>  <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>65</span> 6c 6c 6f <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>62</span>  <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>21</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  |hello rbd!......|
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000010</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  |................|
</span></span><span style=display:flex><span>*
</span></span><span style=display:flex><span><span style=color:#ae81ff>02000000</span>
</span></span></code></pre></div><h2 id=调试运行客户端程序>调试运行客户端程序</h2><h3 id=安装配置gdb>安装配置GDB</h3><pre tabindex=0><code>root@haosheng-dev2:/work/ceph_test# apt-get install gdb -y
root@haosheng-dev2:/work/ceph_test# cat ~/.gdbinit
set history save on
set print pretty on
</code></pre><h3 id=编写调试的配置文件>编写调试的配置文件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@haosheng-dev2:/work/ceph_test# cat run_hello_rbd.gdb
</span></span><span style=display:flex><span>set breakpoint pending on
</span></span><span style=display:flex><span>handle SIGUSR2 noprint nostop
</span></span><span style=display:flex><span>handle SIGUSR1 noprint nostop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>file /work/ceph_test/hello_rbd <span style=color:#75715e># 设置调试的程序</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>break hello_rbd.cc:139 <span style=color:#75715e># 设置初始断点</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>run -c /work/ceph/build/ceph.conf <span style=color:#75715e># 设置运行参数</span>
</span></span></code></pre></div><h3 id=执行调试>执行调试</h3><pre tabindex=0><code>root@haosheng-dev2:/work/ceph_test# gdb -x run_hello_rbd.gdb
we just connected to the rados cluster
we just created an ioctx for our pool
[New Thread 0x7fffb77fe700 (LWP 1342822)]
[New Thread 0x7fffb6ffd700 (LWP 1342823)]
[New Thread 0x7fffb67fc700 (LWP 1342824)]
[New Thread 0x7fffb5ffb700 (LWP 1342825)]
we just opened the rbd image
Thread 1 &#34;hello_rbd&#34; hit Breakpoint 1, main (argc=3, argv=0x7fffffffe468) at hello_rbd.cc:139
warning: Source file is more recent than executable.
139             ret = image.write(0, len, bl);
(gdb)
</code></pre><p>发现程序暂停在预设置的断点处。</p><h2 id=参考>参考</h2><ul><li><a href=https://blog.csdn.net/XingKong_678/article/details/51590459>https://blog.csdn.net/XingKong_678/article/details/51590459</a></li><li><a href=https://github.com/ceph/ceph/blob/master/examples/librbd/hello_world.cc>https://github.com/ceph/ceph/blob/master/examples/librbd/hello_world.cc</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://hawkhe.github.io/>&copy; Hawk's Blog 2023</a><div><div class=ananke-socials></div></div></div></footer></body></html>